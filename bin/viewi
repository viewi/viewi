#!/usr/bin/env php
<?php

$cliTool = new ViewiCLITool();
$cliTool->exec($argv);
class ViewiCLITool
{

    static array $commands = [
        'new' => [
            'description' => 'Initialize Viewi application.',
            'arguments' => [
                'directory' => [
                    'optional' => true,
                    'default' => 'viewi',
                    'description' => 'Directory for Viewi components'
                ]
            ],
            'action' => 'createNew'
        ],
        'help' => [
            'description' => 'Prints all avaliable commands.',
            'action' => 'help'
        ]
    ];

    function exec($argv)
    {
        $inputs = array_slice($argv, 1);
        if (!isset($inputs[0])) {
            echo "You must specify command\n";
            $this->help();
            return;
        }
        $command = $inputs[0];
        if (!isset(self::$commands[$command])) {
            echo "Command '$command' is not supported.\n";
            $this->help();
            return;
        }
        $commandProps = self::$commands[$command];
        $action = $commandProps['action'];
        $this->$action($inputs, $command);
    }

    function help($inputs = [], $invokedCommand = '', string $command = '')
    {
        echo "Supported commands:\n\n";
        foreach (self::$commands as $command => $props) {
            $arguments = $props['arguments'] && count($props['arguments']) > 0 ?
                '<' . implode('> <', array_keys($props['arguments'])) . '>' :
                '';
            echo "    $command $arguments\n    ({$props['description']})\n";
            if ($arguments) {
                echo "    - arguments\n";
                foreach ($props['arguments'] as $argument => $argDetail) {
                    $details = $argDetail['optional'] ? '; optional' : '; required';
                    $details .= $argDetail['default'] ? ';  default: ' . $argDetail['default'] : '';
                    echo "        $argument - {$argDetail['description']}$details\n";
                }
            }
            echo "\n";
        }
    }

    function createNew($inputs, $command)
    {
        echo "Starting setting up View for you.\n";
        // create directory
        $projectDir = getcwd();
        $viewiDir = isset($inputs[1]) && trim($inputs[1], ' \\/') ?
            trim($inputs[1], ' \\/') :
            'viewi-app';
        
        if ($viewiDir === 'viewi-app' && file_exists("$projectDir/src")) {
            $viewiDir = 'ViewiApp';
            $viewiDir = "src/$viewiDir";
        }
        $viewiDirFullPath = "$projectDir/$viewiDir";
        if (file_exists($viewiDirFullPath)) {
            echo "Viewi directory '$viewiDir' alredy exists. To continue please remove the old one or select another folder.\n";
            return;
        }
        echo "Creating directory '$viewiDir'..\n";
        mkdir($viewiDirFullPath);
        $rootPath = '';
        $indexPath = 'index.php';
        $publicPath = '/';
        if (file_exists("$projectDir/public/index.php")) {
            $rootPath = "/..";
            $indexPath = 'public/index.php';
            $publicPath = 'public/';
        }
        if (file_exists("$projectDir/www/index.php")) {
            $rootPath = "/..";
            $indexPath = 'www/index.php';
            $publicPath = 'www/';
        }
        // copy contents
        $newAppStubs = 'vendor/viewi/viewi/stubs/new-app';
        $newAppStubsPath = "$projectDir/$newAppStubs";
        echo "Copying files..\n";
        if (file_exists($newAppStubsPath)) {
            $this->recurse_copy($newAppStubsPath, $viewiDirFullPath);
        } else {
            echo "Can't find path '$newAppStubsPath'\n";
        }
        // set up config
        $configPath = "$projectDir/$viewiDir/config.php";
        echo "Updating config..\n";
        if (file_exists($configPath)) {
            $content = file_get_contents($configPath);
            $content = str_replace('##public##', "$rootPath/$publicPath", $content);
            file_put_contents($configPath, $content);
        } else {
            echo "Can't find path '$configPath'\n";
        }
        // update composer.json
        $composerFile = "$projectDir/composer.json";
        echo "Updating composer.json..\n";
        if (file_exists($composerFile)) {
            $content = file_get_contents($composerFile);
            $json = json_decode($content, true);
            if (!isset($json['autoload'])) {
                $json['autoload'] = [];
            }
            if (!isset($json['autoload']['psr-4'])) {
                $json['autoload']['psr-4'] = [];
            }
            $json['autoload']['psr-4']['Components\\'] = "$viewiDir/Components/";
            $content = json_encode(
                $json,
                JSON_PRETTY_PRINT |
                    JSON_UNESCAPED_SLASHES |
                    JSON_UNESCAPED_UNICODE
            );
            file_put_contents($composerFile, $content);
        } else {
            echo "Can't find composer.json file.\n";
        }
        // composer install
        $composerPhar = "$projectDir/composer.phar";
        echo "composer install\n";
        if (file_exists($composerPhar)) {
            echo shell_exec("php composer.phar install");
        } else {
            echo shell_exec("composer install");
        }
        echo "\n";
        // update index.php
        $appCode = "\n\n" .
            "// Viewi application here, uncomment to use as standalone application\n" .
            "// include __DIR__ . '$rootPath/$viewiDir/viewi.php';\n" .
            "// Viewi\App::handle();";
        $indexFilePath = "$projectDir/$indexPath";
        if (file_exists($indexFilePath)) {
            $content = file_get_contents($indexFilePath);
            if (strpos($content, "$viewiDir/viewi.php") === false) {
                echo "Updating index.php\n";
                $content .= $appCode;
                file_put_contents($indexFilePath, $content);
            }
        }
        // finish up
        echo "All is set up. Enjoy!\n";
    }

    function recurse_copy($src, $dst)
    {
        $dir = opendir($src);
        @mkdir($dst);
        while (false !== ($file = readdir($dir))) {
            if (($file != '.') && ($file != '..')) {
                if (is_dir($src . '/' . $file)) {
                    $this->recurse_copy($src . '/' . $file, $dst . '/' . $file);
                } else {
                    copy($src . '/' . $file, $dst . '/' . $file);
                }
            }
        }
        closedir($dir);
    }
}
